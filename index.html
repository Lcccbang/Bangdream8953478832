<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¶²ç«™é€£çµæ¸…å–®</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --ring: #06b6d4;     /* é’è—èšç„¦ */
      --brand: #06b6d4;   /* ä¸»è‰²ï¼šé’è— */
      --brand-2: #8b5cf6; /* è¼”è‰²ï¼šæŸ”ç´« */
      --text: #0f172a;    /* å­—è‰²æ·±è—ç° */
      --muted: #64748b;   /* æ¬¡è¦æ–‡å­— */
      --line: #e5e7eb;    /* é‚Šç·š */
      --card: #ffffff;    /* å¡ç‰‡åº• */
      --bg: #ffffff;      /* ç´”ç™½èƒŒæ™¯ */
      --good: #10b981;
      --bad: #ef4444;
    }
    body { color: var(--text); background: var(--bg); }
    .animate-in { animation: fadeUp .45s ease both; }
    @keyframes fadeUp { from { opacity:.0; transform: translateY(8px)} to {opacity:1; transform:none} }
    .ring-focus:focus{
      outline: none;
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--ring) 30%, transparent);
    }
    /* å¡ç‰‡é™°å½±èˆ‡é‚Šæ¡†ï¼ˆç™½åº•æ›´æ¸…æ™°ï¼‰ */
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      box-shadow: 0 6px 20px rgba(2, 6, 23, 0.06);
    }
    .card:hover { box-shadow: 0 10px 28px rgba(2, 6, 23, 0.10); }
    /* å°é¸å–®æµ®å±¤é™°å½± */
    .menu-shadow { box-shadow: 0 12px 30px rgba(2,6,23,.16); }
    /* æ²å‹•æ¢ï¼ˆäº®è‰²ç³»ï¼‰ */
    ::-webkit-scrollbar{ height:10px; width:10px }
    ::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:999px }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto px-6 py-10 space-y-6">
    <!-- Header -->
    <header class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">æˆ‘çš„ç¶²ç«™é€£çµæ¸…å–®</h1>
        <p class="text-slate-600 mt-2">æ”¯æ´è‡ªè¨‚æ¨™ç±¤ã€æœå°‹ã€æ‹–æ›³æ’åºã€å»é‡èˆ‡ç¶²ç«™å°åœ–æ¨™ã€‚</p>
      </div>
      <!-- æœå°‹ -->
      <div class="flex gap-2 items-center">
        <div class="relative">
          <input id="searchInput" placeholder="æœå°‹åç¨±æˆ–ç¶²åŸŸ"
                 class="ring-focus w-72 max-w-[70vw] rounded-xl bg-white border border-gray-200 px-4 py-2.5 placeholder-slate-400 focus:border-cyan-300">
          <span class="absolute right-3 top-2.5 text-slate-400">âŒ˜K</span>
        </div>
        <button id="clearSearch" class="rounded-xl bg-gray-100 hover:bg-gray-200 text-slate-700 px-3 py-2 text-sm border border-gray-200">æ¸…é™¤</button>
      </div>
    </header>

    <!-- é¡åˆ¥åˆ‡æ› + ç®¡ç† -->
   <div class="flex items-center justify-between">
      <nav id="categoryTabs" class="flex flex-wrap gap-2"></nav>
      <button id="manageTagsBtn" class="rounded-full bg-cyan-500 hover:bg-cyan-400 text-white px-4 py-2 text-sm">ç®¡ç†æ¨™ç±¤</button>
      <button id="toggleAddBtn" class="rounded-full bg-cyan-500 hover:bg-cyan-400 text-white px-4 py-2 text-sm">æ–°å¢é€£çµ</button>
    </div>

    <!-- ç®¡ç†æ¨™ç±¤é¢æ¿ -->
    <section id="managePanel" class="hidden animate-in rounded-2xl card p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">ç®¡ç†æ¨™ç±¤</h2>
        <button id="closeManage" class="rounded-lg bg-gray-100 hover:bg-gray-200 text-slate-700 px-3 py-1.5 text-sm border border-gray-200">é—œé–‰</button>
      </div>
      <div class="grid gap-4 md:grid-cols-3">
        <div class="md:col-span-1">
          <label class="block text-sm mb-1 text-slate-600">æ–°å¢æ¨™ç±¤</label>
          <div class="flex gap-2">
            <input id="newTagInput" type="text" placeholder="è¼¸å…¥æ–°æ¨™ç±¤"
              class="ring-focus w-full rounded-xl bg-white border border-gray-200 px-3 py-2.5">
            <button id="addNewTag" class="rounded-xl bg-violet-500 hover:bg-violet-400 text-white px-4">æ–°å¢</button>
          </div>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-2 text-slate-600">å·²å»ºç«‹æ¨™ç±¤ï¼ˆé»æ“Šåƒåœ¾æ¡¶åˆªé™¤ï¼‰</label>
          <div id="tagList" class="flex flex-wrap gap-2"></div>
          <p class="text-xs text-slate-500 mt-2">æé†’ï¼šåˆªé™¤å¾Œï¼Œå¥—ç”¨è©²æ¨™ç±¤çš„é …ç›®æœƒè‡ªå‹•æ”¹ç‚ºã€Œå…¶ä»–ã€ã€‚ä¸èƒ½åˆªé™¤ã€Œå…¨éƒ¨ã€ã€‚</p>
        </div>
      </div>
    </section>

    <!-- æ–°å¢é€£çµ -->
    <section class="rounded-2xl card p-0 animate-in overflow-hidden">
      <!-- æç¤ºè¨Šæ¯ç½®æ–¼æ”¶åˆå€å¡Šå¤–ï¼Œç¢ºä¿ä»»ä½•ç‹€æ…‹éƒ½èƒ½çœ‹åˆ° -->
      <p id="msg" class="px-5 pt-3 text-sm hidden"></p>
      <div id="addPanel" class="hidden p-5 sm:p-6">
        <form id="linkForm" class="grid grid-cols-1 md:grid-cols-12 gap-3">
          <div class="md:col-span-3">
            <label class="block text-sm mb-1 text-slate-600">ç¶²ç«™åç¨±</label>
            <input id="nameInput" type="text" placeholder="ä¾‹å¦‚ï¼šå®˜æ–¹ç¶²ç«™"
                   class="ring-focus w-full rounded-xl bg-white border border-gray-200 px-4 py-2.5 placeholder-slate-400 focus:border-cyan-300"
                   required />
          </div>
          <div class="md:col-span-5">
            <label class="block text-sm mb-1 text-slate-600">ç¶²å€</label>
            <input id="urlInput" type="url" placeholder="ä¾‹å¦‚ï¼šhttps://example.com"
                   class="ring-focus w-full rounded-xl bg-white border border-gray-200 px-4 py-2.5 placeholder-slate-400 focus:border-cyan-300"
                   required />
          </div>
          <div class="md:col-span-3">
            <label class="block text-sm mb-1 text-slate-600">æ¨™ç±¤</label>
            <div class="flex gap-2">
              <select id="categorySelect"
                      class="ring-focus w-full rounded-xl bg-white border border-gray-200 px-3 py-2.5 focus:border-cyan-300">
              </select>
              <button id="addCatBtn" type="button"
                class="rounded-xl bg-cyan-500 hover:bg-cyan-400 text-white font-semibold px-3">ï¼‹</button>
            </div>
          </div>
          <div class="md:col-span-1 flex items-end">
            <button id="addBtn" type="submit"
                    class="w-full rounded-xl bg-cyan-500 hover:bg-cyan-400 text-white font-semibold px-4 py-2.5 transition-colors">
              æ–°å¢
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- æ¸…å–® -->
    <section>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">æˆ‘çš„é€£çµ</h2>
        <div class="text-sm text-slate-600">
          å…± <span id="count">0</span> å€‹
        </div>
      </div>
      <div id="cards" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <footer class="text-center text-slate-500 text-sm">
      å°æç¤ºï¼šå³ä¸Šè§’åƒåœ¾æ¡¶å¯å¿«é€Ÿåˆªé™¤ï¼›æ‹–æ›³å¯é‡æ–°æ’åºï¼›ç”¨ä¸Šæ–¹æœå°‹å¯å¿«é€Ÿéæ¿¾ã€‚
    </footer>
  </div>

  <script>
    // å…§å»ºæ¨™ç±¤ï¼ˆå¯è‡ªè¨‚ï¼‰
    const DEFAULT_CATS = ["å…¨éƒ¨", "å°èªª", "å­¸ç¿’", "æ ¡å‹™", "å…¶ä»–"];

    // åˆå§‹è³‡æ–™ï¼ˆå«é åˆ†æ¨™ç±¤ï¼‰
    const initialLinks = [
      { name: "ZeroJudge", url: "https://zerojudge.tw/", cat: "å­¸ç¿’" },
      { name: "è‡ºåŒ—å¸‚æ•™å¸«æ­·ç¨‹", url: "https://e-portfolio.cooc.tp.edu.tw/Portal.do?sec=6KuL5YWI55m75YWl77yB&dec=true", cat: "æ ¡å‹™" },
      { name: "Canva", url: "https://www.canva.com/", cat: "å­¸ç¿’" },
      { name: "PyPI", url: "https://pypi.org/", cat: "å­¸ç¿’" },
      { name: "å°åŒ—å¸‚æ ¡å‹™è¡Œæ”¿", url: "https://sschool.tp.edu.tw/Index.action", cat: "æ ¡å‹™" },
      { name: "ESJ Zone", url: "https://www.esjzone.cc/", cat: "å°èªª" },
      { name: "Linovelib", url: "https://www.linovelib.com/", cat: "å°èªª" },
      { name: "LightNovel.fun", url: "https://www.lightnovel.fun/", cat: "å°èªª" },
      { name: "Kakuyomu", url: "https://kakuyomu.jp/", cat: "å°èªª" },
      { name: "Syosetu", url: "https://syosetu.com/", cat: "å°èªª" },
      { name: "Comic Walker", url: "https://comic-walker.com/", cat: "å°èªª" },
      { name: "Comic Gardo", url: "https://comic-gardo.com/", cat: "å°èªª" },
      { name: "POPO åŸå‰µå¸‚é›†", url: "https://www.popo.tw/index", cat: "å°èªª" },
      { name: "UU çœ‹æ›¸", url: "https://uukanshu.cc/class_9_1.html", cat: "å°èªª" },
      { name: "è®€ç†±å°èªª", url: "https://www.drxsw.com/", cat: "å°èªª" },
      { name: "è¼•æ–‡åº« qbtr", url: "https://www.qbtr.cc/", cat: "å°èªª" },
      { name: "Novel543", url: "https://www.novel543.com/", cat: "å°èªª" },
      { name: "JPXS123", url: "https://www.jpxs123.com/", cat: "å°èªª" },
      { name: "Book543", url: "https://www.book543.net/", cat: "å°èªª" },
      { name: "å°å¤§é–‹æ”¾å¼èª²ç¨‹", url: "https://ocw.aca.ntu.edu.tw/", cat: "å­¸ç¿’" },
      { name: "Google å­¸è¡“æœå°‹", url: "https://scholar.google.com/", cat: "å­¸ç¿’" },
      { name: "VS Code", url: "https://code.visualstudio.com/", cat: "å­¸ç¿’" },
      { name: "W3Schools CSS", url: "https://www.w3schools.com/css/", cat: "å­¸ç¿’" },
      { name: "CSS ç­†è¨˜", url: "https://hackmd.io/@AndyChiang/CSSnote", cat: "å­¸ç¿’" },
      { name: "è‡ºåŒ—å¸‚æ•™ç ”é™¢èª²ç¨‹", url: "https://cerclearning.tp.edu.tw/classical/datapage/195", cat: "æ ¡å‹™" },
      { name: "COOC+", url: "https://coocplus.tp.edu.tw/", cat: "æ ¡å‹™" },
      { name: "iLearning", url: "https://web.jhenggao.com/iLearning/Login.aspx?c=500", cat: "æ ¡å‹™" },
      { name: "å°å¤§å°èª", url: "https://tai2.ntu.edu.tw/", cat: "å­¸ç¿’" },
      { name: "Algodoo", url: "https://www.algodoo.com/", cat: "å­¸ç¿’" },
      { name: "Replit", url: "https://replit.com/", cat: "å­¸ç¿’" },
      { name: "AutoHotkey è«–å£‡", url: "https://www.autohotkey.com/boards/", cat: "å­¸ç¿’" },
      { name: "edX", url: "https://www.edx.org/", cat: "å­¸ç¿’" },
      { name: "ewant", url: "https://www.ewant.org/", cat: "å­¸ç¿’" },
      { name: "iFreeSite ç·¨è¼¯å™¨", url: "https://www.ifreesite.com/editor/", cat: "å­¸ç¿’" },
      { name: "Google Colab", url: "https://colab.research.google.com/#scrollTo=Wf5KrEb6vrkR", cat: "å­¸ç¿’" },
      { name: "TicketPlus", url: "https://ticketplus.com.tw/", cat: "å…¶ä»–" },
      { name: "è²“å’ªæ±½è»Š", url: "https://www.catcarbuy.com/", cat: "å…¶ä»–" },
    ];

    // å„²å­˜éµ
    const STORAGE_KEY_ITEMS = "link-cards-v5-items";
    const STORAGE_KEY_CATS = "link-cards-v5-cats";
    const STORAGE_KEY_FILTER = "link-cards-v5-filter";
    const STORAGE_KEY_SEARCH = "link-cards-v5-search";

    // ç‹€æ…‹
    let items = [];      // {id, name, url, cat}
    let cats = [];       // ["å°èªª", "å­¸ç¿’", ...]ï¼ˆä¸å«ã€Œå…¨éƒ¨ã€ï¼‰
    let filterCat = "å…¨éƒ¨";
    let searchText = "";

    // å·¥å…·ï¼šä¸»ç¶²åŸŸ
    function extractDomain(url) {
      try {
        const u = new URL(url);
        const parts = u.hostname.split(".");
        if (parts.length >= 3) {
          const commons = ["www", "m", "dev", "app", "blog"];
          if (commons.includes(parts[0])) parts.shift();
        }
        return parts.join(".");
      } catch { return url; }
    }

    // å·¥å…·ï¼šfavicon ä¾†æº
    function faviconFor(url) {
      try {
        const u = new URL(url);
        const primary = `https://www.google.com/s2/favicons?domain=${u.origin}&sz=64`;
        const fallback = `${u.origin}/favicon.ico`;
        return { primary, fallback, domain: extractDomain(url) };
      } catch {
        return { primary: "", fallback: "", domain: url };
      }
    }

    // å·¥å…·
    const uid = () => Math.random().toString(36).slice(2, 10);

    // å»é‡ï¼ˆä»¥æ¨™æº–åŒ–å¾Œçš„ç¶²å€ç‚ºæº–ï¼‰
    function normalizeUrl(url){
      try {
        const u = new URL(url);
        u.hash = "";
        ["utm_source","utm_medium","utm_campaign","utm_content","utm_term","gclid","fbclid","wbraid","srsltid"].forEach(p=>u.searchParams.delete(p));
        return u.toString();
      } catch { return url.trim(); }
    }

    // åˆå§‹åŒ–
    function load() {
      // æ¨™ç±¤
      const savedCats = JSON.parse(localStorage.getItem(STORAGE_KEY_CATS) || "null");
      cats = Array.isArray(savedCats) ? savedCats : DEFAULT_CATS.slice(1); // å»æ‰ã€Œå…¨éƒ¨ã€

      // é …ç›®
      const savedItems = JSON.parse(localStorage.getItem(STORAGE_KEY_ITEMS) || "null");
      if (Array.isArray(savedItems)) {
        items = savedItems;
      } else {
        // åˆæ¬¡å°å…¥ï¼šå¥—ä¸Š id èˆ‡å»é‡
        const map = new Map();
        initialLinks.forEach(l => {
          const key = normalizeUrl(l.url);
          if (!map.has(key)) map.set(key, { id: uid(), name: l.name, url: key, cat: l.cat || "å…¶ä»–" });
        });
        items = [...map.values()];
        save();
      }

      // ç¯©é¸èˆ‡æœå°‹
      filterCat = localStorage.getItem(STORAGE_KEY_FILTER) || "å…¨éƒ¨";
      searchText = localStorage.getItem(STORAGE_KEY_SEARCH) || "";

      renderCats();
      render();
      document.getElementById("searchInput").value = searchText;
      renderManagePanel();
    }

    function save() {
      localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(items));
      localStorage.setItem(STORAGE_KEY_CATS, JSON.stringify(cats));
      localStorage.setItem(STORAGE_KEY_FILTER, filterCat);
      localStorage.setItem(STORAGE_KEY_SEARCH, searchText);
    }

    // é¡åˆ¥ç±¤
    function renderCats() {
      const tabs = document.getElementById("categoryTabs");
      tabs.innerHTML = "";
      const allCats = ["å…¨éƒ¨", ...cats];
      allCats.forEach(c => {
        const active = c === filterCat;
        const btn = document.createElement("button");
        btn.className = (active
          ? "bg-cyan-500 text-white border-cyan-400"
          : "bg-gray-100 text-slate-700 hover:bg-gray-200 border-gray-200")
          + " rounded-full px-3 py-1.5 text-sm border transition-colors";
        btn.textContent = c;
        btn.onclick = () => { filterCat = c; save(); render(); };
        tabs.appendChild(btn);
      });

      // è¡¨å–®ä¸‹æ‹‰
      const sel = document.getElementById("categorySelect");
      sel.innerHTML = "";
      cats.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c; opt.textContent = c;
        sel.appendChild(opt);
      });
      if (!cats.includes("å…¶ä»–")) { cats.push("å…¶ä»–"); save(); renderCats(); return; }
    }

    // ç®¡ç†é¢æ¿
    function renderManagePanel(){
      const wrap = document.getElementById("tagList");
      wrap.innerHTML = "";
      cats.forEach(c => {
        const pill = document.createElement("span");
        pill.className = "inline-flex items-center gap-2 rounded-full border border-gray-200 bg-gray-50 px-3 py-1.5 text-sm text-slate-700";
        pill.innerHTML = `<span>${c}</span>
          <button title="åˆªé™¤" class="delete-tag rounded-full bg-white border border-gray-200 hover:bg-gray-100 text-slate-700 px-2 py-0.5 text-xs">ğŸ—‘</button>`;
        pill.querySelector(".delete-tag").onclick = () => {
          // åˆªé™¤æ¨™ç±¤ï¼šæŠŠå¥—ç”¨è©²æ¨™ç±¤çš„é …ç›®æ”¹æˆã€Œå…¶ä»–ã€
          const idx = cats.indexOf(c);
          if (idx === -1) return;
          cats.splice(idx,1);
          items = items.map(it => it.cat === c ? { ...it, cat: "å…¶ä»–" } : it);
          if (filterCat === c) filterCat = "å…¨éƒ¨";
          save();
          renderCats();
          render();
          renderManagePanel();
          toast(`å·²åˆªé™¤æ¨™ç±¤ã€Œ${c}ã€ä¸¦å°‡é …ç›®ç§»è‡³ã€Œå…¶ä»–ã€`,"good");
        };
        wrap.appendChild(pill);
      });
    }

    // ç®¡ç†æ¨™ç±¤é–‹åˆ
    document.getElementById("manageTagsBtn").addEventListener("click", ()=>{
      document.getElementById("managePanel").classList.toggle("hidden");
    });
    document.getElementById("closeManage").addEventListener("click", ()=>{
      document.getElementById("managePanel").classList.add("hidden");
    });
    document.getElementById("addNewTag").addEventListener("click", ()=>{
      const input = document.getElementById("newTagInput");
      const name = input.value.trim();
      if (!name) return;
      if (["å…¨éƒ¨", ...cats].includes(name)) { toast("æ­¤æ¨™ç±¤å·²å­˜åœ¨","bad"); return; }
      cats.push(name);
      input.value = "";
      save();
      renderCats();
      renderManagePanel();
      toast("å·²æ–°å¢æ¨™ç±¤","good");
    });

    // æ–°å¢é€£çµé–‹åˆ
    document.getElementById("toggleAddBtn").addEventListener("click", ()=>{
      document.getElementById("addPanel").classList.toggle("hidden");
    });

    // æ–°å¢æ¨™ç±¤ï¼ˆè¡¨å–®ï¼‹æŒ‰éˆ•ï¼‰
    document.getElementById("addCatBtn").addEventListener("click", () => {
      const name = prompt("è¼¸å…¥æ–°æ¨™ç±¤åç¨±ï¼š");
      if (!name) return;
      const clean = name.trim();
      if (!clean) return;
      if (["å…¨éƒ¨", ...cats].includes(clean)) { toast("æ­¤æ¨™ç±¤å·²å­˜åœ¨", "bad"); return; }
      cats.push(clean);
      save();
      renderCats();
      // è‡ªå‹•é¸åˆ°æ–°æ¨™ç±¤
      const sel = document.getElementById("categorySelect");
      sel.value = clean;
      toast("å·²æ–°å¢æ¨™ç±¤", "good");
    });

    // å¡ç‰‡
    function createCard(item) {
      const card = document.createElement("div");
      card.className = "group relative rounded-2xl card p-4 transition-shadow animate-in";
      card.draggable = true;
      card.dataset.id = item.id;

      const header = document.createElement("div");
      header.className = "flex items-start gap-3";

      // åœ–æ¨™
      const iconWrap = document.createElement("div");
      iconWrap.className = "shrink-0 w-10 h-10 rounded-xl bg-white border border-gray-200 grid place-items-center overflow-hidden";
      const fav = document.createElement("img");
      const favInfo = faviconFor(item.url);
      fav.alt = favInfo.domain + " åœ–æ¨™";
      fav.className = "w-6 h-6";
      fav.src = favInfo.primary;
      fav.referrerPolicy = "no-referrer";
      fav.onerror = function(){
        if (fav.src !== favInfo.fallback) {
          fav.src = favInfo.fallback;
        } else {
          fav.src = '';
          fav.alt = 'Image failed to load';
          fav.style.display = 'none';
          iconWrap.innerHTML = '';
          const badge = document.createElement('div');
          badge.textContent = (item.name || favInfo.domain).trim().charAt(0).toUpperCase();
          badge.className = 'w-10 h-10 grid place-items-center rounded-xl bg-gradient-to-tr from-cyan-400 to-violet-400 text-white font-bold';
          iconWrap.appendChild(badge);
        }
      };
      iconWrap.appendChild(fav);

      // ä¸»å…§å®¹ï¼ˆæ¨™é¡Œ + åˆªé™¤åœ–ç¤º + ç¶²åŸŸï¼‰
      const main = document.createElement("div");
      main.className = "flex-1 min-w-0";

      const title = document.createElement("a");
      title.href = item.url;
      title.target = "_blank";
      title.rel = "noopener noreferrer";
      title.className = "font-semibold leading-snug text-slate-800 hover:text-cyan-700 transition-colors";
      title.textContent = item.name || favInfo.domain;

      const domain = document.createElement("div");
      domain.className = "text-sm text-slate-500 mt-0.5";
      domain.textContent = favInfo.domain;

      main.appendChild(title);
      main.appendChild(domain);

      // å³ä¸Šè§’ï¼šåˆªé™¤åœ–ç¤ºèˆ‡æ¨™ç±¤
      const menuWrap = document.createElement("div");
      menuWrap.className = "absolute right-3 top-3 flex items-center gap-2";

      const delIcon = document.createElement("button");
      delIcon.className = "shrink-0 rounded-full border border-gray-200 bg-white hover:bg-rose-50 text-rose-600 hover:text-rose-700 px-2 py-1 text-xs z-10";
      delIcon.title = "åˆªé™¤æ­¤é€£çµ";
      delIcon.textContent = "ğŸ—‘";
      delIcon.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); removeItem(item.id); };

      const chip = document.createElement("span");
      chip.className = "rounded-full bg-gray-100 border border-gray-200 px-2.5 py-1 text-xs text-slate-700";
      chip.textContent = item.cat || "å…¶ä»–";

      menuWrap.appendChild(delIcon);
      menuWrap.appendChild(chip);

      // åº•éƒ¨ï¼šå‰å¾€
      const go = document.createElement("a");
      go.href = item.url;
      go.target = "_blank";
      go.rel = "noopener noreferrer";
      go.className = "mt-3 inline-flex items-center gap-2 text-sm text-cyan-700 hover:text-cyan-600";
      go.innerHTML = `å‰å¾€ç¶²ç«™ <span aria-hidden>â†—</span>`;

      header.appendChild(iconWrap);
      header.appendChild(main);
      card.appendChild(header);
      card.appendChild(menuWrap);
      card.appendChild(go);

      // æ‹–æ›³æ’åº
      card.addEventListener("dragstart", (e) => {
        card.classList.add("opacity-60");
        e.dataTransfer.setData("text/plain", item.id);
      });
      card.addEventListener("dragend", () => card.classList.remove("opacity-60"));
      card.addEventListener("dragover", (e) => {
        e.preventDefault();
        card.classList.add("ring-2");
      });
      card.addEventListener("dragleave", () => card.classList.remove("ring-2"));
      card.addEventListener("drop", (e) => {
        e.preventDefault();
        card.classList.remove("ring-2");
        const fromId = e.dataTransfer.getData("text/plain");
        const toId = item.id;
        reorder(fromId, toId);
      });

      return card;
    }

    // æ¸²æŸ“
    function render() {
      const wrap = document.getElementById("cards");
      const count = document.getElementById("count");

      // ç¯©é¸èˆ‡æœå°‹
      const list = items.filter(it => {
        const catOk = filterCat === "å…¨éƒ¨" ? true : (it.cat || "å…¶ä»–") === filterCat;
        const text = (it.name + " " + extractDomain(it.url)).toLowerCase();
        const searchOk = !searchText ? true : text.includes(searchText.toLowerCase());
        return catOk && searchOk;
      });

      // ç¾æœ‰ç¯€é»æ˜ å°„
      const existing = new Map([...wrap.children].map(c => [c.dataset.id, c]));
      const seen = new Set();

      list.forEach(it => {
        let node = existing.get(it.id);
        if (!node) {
          node = createCard(it);
          wrap.appendChild(node);
        } else {
          // æ›´æ–°ä¸»è¦æ–‡å­—èˆ‡æ¨™ç±¤è† å›Š
          const link = node.querySelector("a.font-semibold");
          const domain = node.querySelector(".text-sm.text-slate-500");
          const chip = node.querySelector("span.rounded-full");
          if (link && link.textContent !== (it.name || extractDomain(it.url))) link.textContent = it.name || extractDomain(it.url);
          if (link && link.href !== it.url) link.href = it.url;
          if (domain && domain.textContent !== extractDomain(it.url)) domain.textContent = extractDomain(it.url);
          if (chip && chip.textContent !== (it.cat || "å…¶ä»–")) chip.textContent = it.cat || "å…¶ä»–";
        }
        seen.add(it.id);
      });

      // ç§»é™¤ä¸åœ¨åˆ—è¡¨ä¸­çš„ç¯€é»
      [...wrap.children].forEach(c => {
        if (!seen.has(c.dataset.id)) wrap.removeChild(c);
      });

      // ä¾ items é †åºé‡æ–°æ’åˆ—é¡¯ç¤ºçš„ç¯€é»
      const order = new Map(items.map((it, i) => [it.id, i]));
      [...wrap.children]
        .sort((a, b) => order.get(a.dataset.id) - order.get(b.dataset.id))
        .forEach(n => wrap.appendChild(n));

      count.textContent = list.length;
    }

    // æ–°å¢ / åˆªé™¤ / æ’åº
    function addItem(name, url, cat) {
      const u = normalizeUrl(url);
      if (items.some(it => normalizeUrl(it.url) === u)) {
        toast("å·²å­˜åœ¨ç›¸åŒç¶²å€ï¼Œå·²ç•¥é", "bad");
        return;
      }
      items.push({ id: uid(), name, url: u, cat: cat || "å…¶ä»–" });
      save(); render(); toast("å·²æ–°å¢", "good");
    }
    function removeItem(id) {
      const before = items.length;
      items = items.filter(i => i.id !== id);
      save(); render();
      toast(before !== items.length ? "å·²åˆªé™¤" : "æ‰¾ä¸åˆ°é€™å€‹é …ç›®", before !== items.length ? "good" : "bad");
    }
    function reorder(fromId, toId) {
      if (fromId === toId) return;
      const fromIndex = items.findIndex(i => i.id === fromId);
      const toIndex = items.findIndex(i => i.id === toId);
      if (fromIndex === -1 || toIndex === -1) return;
      const [moved] = items.splice(fromIndex, 1);
      items.splice(toIndex, 0, moved);
      save(); render();
    }

    // è¡¨å–®è™•ç†
    document.getElementById("linkForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const name = document.getElementById("nameInput").value.trim();
      const url = document.getElementById("urlInput").value.trim();
      const cat = document.getElementById("categorySelect").value || "å…¶ä»–";
      if (!name || !url) return;
      try {
        const u = new URL(url);
        if (!/^https?:$/.test(u.protocol)) throw new Error("bad");
      } catch {
        toast("è«‹è¼¸å…¥æ­£ç¢ºçš„ç¶²å€ï¼ˆéœ€å« https://ï¼‰", "bad");
        return;
      }
      addItem(name, url, cat);
      e.target.reset();
      document.getElementById("nameInput").focus();
    });

    // æœå°‹
    const searchInput = document.getElementById("searchInput");
    const clearBtn = document.getElementById("clearSearch");
    searchInput.addEventListener("input", () => { searchText = searchInput.value; localStorage.setItem(STORAGE_KEY_SEARCH, searchText); render(); });
    clearBtn.addEventListener("click", () => { searchText = ""; searchInput.value = ""; localStorage.setItem(STORAGE_KEY_SEARCH, ""); render(); });
    // å¿«æ·éµ
    document.addEventListener("keydown", (e)=>{
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase()==="k") {
        e.preventDefault();
        searchInput.focus();
      }
    });

    // æç¤ºè¨Šæ¯
    function toast(text, type="good") {
      const el = document.getElementById("msg");
      el.textContent = text;
      el.className = "px-5 pt-3 text-sm " + (type === "good" ? "text-emerald-600" : "text-rose-600");
      el.classList.remove("hidden");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => el.classList.add("hidden"), 1400);
    }

    // è¼‰å…¥
    load();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9737d3237377f07b',t:'MTc1NTkyMjkwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
